{%- extends "base.html" %}

{# Loads some of the macros included with Flask-Bootstrap. We are using the
   utils module here to automatically render Flask's flashed messages in a
   bootstrap friendly manner #}
{% import "bootstrap/utils.html" as utils %}

{% block head %}
  {{super()}}
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <script src="{{url_for('static', filename='drawGraph.js')}}"></script>
  <script src="{{url_for('static', filename='sigma.min.js')}}"></script>
  <script src="{{url_for('static', filename='plugins/sigma.layout.forceAtlas2/supervisor.js')}}"></script>
  <script src="{{url_for('static', filename='plugins/sigma.layout.forceAtlas2/worker.js')}}"></script>
  <script src="{{url_for('static', filename='plugins/sigma.plugins.relativeSize/sigma.plugins.relativeSize.js')}}"></script>

  <style type="text/css">
    body {
      margin: 0;
    }
    #sigma-network {
      position: absolute;
      width: 100%;
      height: 100%;
    }
  </style>
{%- endblock %}

{% block content %}
<div class="jumbotron">
    <h2>SAFU hackaton</h2>
    <p>Is the transaction address you are sending your crypto to SAFU?</p>
</div>

<div id="main" class="container">
  
  <script type="text/javascript">
    function getAddress(address_id) {
      // Let's first initialize sigma:
      var s = new sigma('sigma-network');
      s.settings({
        minArrowSize: 100
      });
      
      function draw(address_id) {
        $.getJSON("/api/address/" + address_id, function(json) {
          drawgraph(s, json.origin, json.outgoing_transactions, json.incoming_transactions)
        });
      }

      function onNodeClick(event) {
        var clickedNode = event.data.node;
        draw(clickedNode.id)
      }

      s.bind('clickNode', onNodeClick);

      draw(address_id)
    }
  </script>

  <form action="javascript:;" onsubmit="getAddress(document.getElementById('addressInput').value)">
    <div class="form-group">
        <label for="addressInput">Enter the address to check</label>
        <textarea class="form-control" id="addressInput" rows="1" name="address" placeholder="10hkyBEKt5S2GDfg7aQw6rQepAvnsRyHoYM" required>{{ request.form['query'] }}</textarea>
    </div>

    {% if error %}
      <div class="alert alert-danger" role="alert">
          {{ error_message }}
      </div>
    {% endif %}

    <input type="submit" value="Check">
  </form>


  <div id="sigma-network"></div>
  
  {% if request.method == 'POST' and not error%}
    
    <h3>Outgoing Transactions</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Destination account</th>
          <th>Destination account compromised</th>
        </tr>
      </thead>
      <tbody>
        {% for address in outgoing_transactions %}
        <tr>
          <td>{{ address.id }}</td>
          <td>{{ address.compromised }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <h3>Incoming Transactions</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Orging account</th>
          <th>Origin account compromised</th>
        </tr>
      </thead>
      <tbody>
        {% for address in incoming_transactions %}
        <tr>
          <td>{{ address.id }}</td>
          <td>{{ address.compromised }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

</div>

{%- endblock %}